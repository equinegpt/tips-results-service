{% extends "base.html" %}

{% block title %}
  Jam's Data â€“ {{ date.strftime("%A %d %B %Y") }}
{% endblock %}

{% block body %}
<main class="page-root">

  {# Top header: logo + title + date picker #}
  <header class="page-header">
    <div class="page-header-left">
      <div class="brand-lockup">
        <img
          src="{{ url_for('static', path='stablfy-logo.png') }}"
          alt="Stablfy"
          class="brand-logo"
        />
        <div class="brand-text">
          <div class="brand-title">
            Jam's Data â€“ {{ date.strftime("%A %d %B %Y") }}
          </div>
          <div class="brand-subtitle">
            Tips Results Service
          </div>
        </div>
      </div>
    </div>

    <div class="page-header-right">
      <form class="date-form" method="get" action="/ui/jams-data">
        <span class="date-form-label">Date</span>
        <div class="date-form-input-wrap">
          <span class="date-form-icon">ðŸ“…</span>
          <input
            type="date"
            id="date"
            name="date"
            value="{{ date.isoformat() }}"
          />
        </div>
        <button type="submit" class="btn-go">Go</button>
      </form>
    </div>
  </header>

  {% if meetings|length > 0 %}

    {# Day summary #}
    {% if day_summary is defined and day_summary %}
      {% set ds = day_summary %}
      <section class="jams-track-card">
        <div class="jams-track-header">
          <h2 class="jams-track-title">Day Summary</h2>
          <div class="jams-stats">
            <div class="jams-stat">
              <span class="jams-stat-value">{{ ds.get('wins', 0) }}/{{ ds.get('tips', 0) }}</span>
              <span class="jams-stat-label">Winners</span>
            </div>
            <div class="jams-stat">
              <span class="jams-stat-value">{{ ds.get('quinellas', 0) }}</span>
              <span class="jams-stat-label">Quinellas</span>
            </div>
            <div class="jams-stat">
              <span class="jams-stat-value">{{ ds.get('trifectas', 0) }}</span>
              <span class="jams-stat-label">Trifectas</span>
            </div>
          </div>
        </div>
      </section>
    {% endif %}

    {# Per-meeting breakdown #}
    {% for m in meetings %}
      {% set ms = m.summary if m.summary is defined else {} %}
      <section class="jams-track-card">
        <div class="jams-track-header">
          <div>
            <h2 class="jams-track-title">{{ m.meeting.track_name }}</h2>
            <span class="state-pill">{{ m.meeting.state }}</span>
          </div>
          <div class="jams-stats">
            <div class="jams-stat">
              <span class="jams-stat-value">{{ ms.get('wins', 0) }}/{{ ms.get('tips', 0) }}</span>
              <span class="jams-stat-label">Winners</span>
            </div>
            <div class="jams-stat">
              <span class="jams-stat-value">{{ ms.get('quinellas', 0) }}</span>
              <span class="jams-stat-label">Quinellas</span>
            </div>
            <div class="jams-stat">
              <span class="jams-stat-value">{{ ms.get('trifectas', 0) }}</span>
              <span class="jams-stat-label">Trifectas</span>
            </div>
          </div>
        </div>

        {# Race-by-race breakdown #}
        {% for r in m.races %}
          <div class="jams-race-row">
            <div class="jams-race-num">Race {{ r.race_number }}</div>

            {# AI Picks column #}
            <div class="jams-picks">
              {% for t in r.tips %}
                <div class="jams-pick">
                  <span class="jams-pick-type">{{ t.tip_type }}:</span>
                  #{{ t.tab_number }} {{ t.horse }}
                </div>
              {% endfor %}
            </div>

            {# Results column - show placings for our tips #}
            <div class="jams-results">
              {% set exotics = r.get('exotics_order', []) %}
              {% for ex in exotics %}
                <div class="jams-result">
                  <span class="jams-pos jams-pos--{{ ex.placing }}">{{ ex.placing }}{{ 'st' if ex.placing == 1 else ('nd' if ex.placing == 2 else 'rd') }}</span>
                  <span>{{ ex.tip_type }}: #{{ ex.tab_number }} {{ ex.horse }}</span>
                </div>
              {% else %}
                <div class="jams-result" style="color: var(--muted);">No top 3 placings</div>
              {% endfor %}
            </div>

            {# Exotic badges #}
            <div class="jams-exotic">
              {% set exotics = r.get('exotics_order', []) %}
              {% if r.get('has_trifecta', false) %}
                <span class="jams-exotic-badge jams-exotic-badge--tri">Trifecta</span>
                {% if exotics|length > 0 and exotics[0].tip_type == 'AI_BEST' %}
                  <span class="jams-ai-first">AI 1st</span>
                {% endif %}
              {% elif r.get('has_quinella', false) %}
                <span class="jams-exotic-badge jams-exotic-badge--quin">Quinella</span>
                {% if exotics|length > 0 and exotics[0].tip_type == 'AI_BEST' %}
                  <span class="jams-ai-first">AI 1st</span>
                {% endif %}
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </section>
    {% endfor %}

  {% else %}
    <p class="empty-state">No data available for this date.</p>
  {% endif %}

</main>
{% endblock %}
