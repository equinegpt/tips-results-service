{% extends "base.html" %}

{% block title %}
  Jam's Data â€“ {{ date.strftime("%A %d %B %Y") }}
{% endblock %}

{% block body %}
<main class="page-root">

  {# Top header #}
  <header class="page-header">
    <div class="page-header-left">
      <div class="brand-lockup">
        <img src="{{ url_for('static', path='stablfy-logo.png') }}" alt="Stablfy" class="brand-logo" />
        <div class="brand-text">
          <div class="brand-title">Jam's Data â€“ {{ date.strftime("%A %d %B %Y") }}</div>
          <div class="brand-subtitle">Tips Results Service</div>
        </div>
      </div>
    </div>
    <div class="page-header-right">
      <form class="date-form" method="get" action="/ui/jams-data">
        <span class="date-form-label">Date</span>
        <div class="date-form-input-wrap">
          <span class="date-form-icon">ðŸ“…</span>
          <input type="date" id="date" name="date" value="{{ date.isoformat() }}" />
        </div>
        <button type="submit" class="btn-go">Go</button>
      </form>
    </div>
  </header>

  {% if meetings|length > 0 %}

    {# Day summary #}
    {% if day_summary is defined and day_summary %}
      {% set ds = day_summary %}
      <section class="meeting-card meeting-card--summary">
        <div class="meeting-header">
          <div class="meeting-header-left">
            <div class="meeting-title-block">
              <h2 class="meeting-title">Day Summary</h2>
            </div>
          </div>
        </div>
        <div class="meeting-body">
          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-label">Winners</div>
              <div class="summary-value summary-value--good">{{ ds.get('wins', 0) }} / {{ ds.get('tips', 0) }}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Strike Rate</div>
              <div class="summary-value">{{ "%.1f"|format(ds.get('strike_rate_pct', 0)) }}%</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Quinellas</div>
              <div class="summary-value jams-highlight-quin">{{ ds.get('quinellas', 0) }}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Trifectas</div>
              <div class="summary-value jams-highlight-tri">{{ ds.get('trifectas', 0) }}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Quaddies</div>
              <div class="summary-value jams-highlight-quaddie">{{ ds.get('quaddies', 0) }}</div>
            </div>
          </div>
        </div>
      </section>
    {% endif %}

    {# Per-meeting cards #}
    {% for m in meetings %}
      {% set ms = m.summary if m.summary is defined else {} %}
      <section class="meeting-card">
        <div class="meeting-header">
          <div class="meeting-header-left">
            <div class="meeting-title-block">
              <div class="meeting-title-row">
                <h2 class="meeting-title">{{ m.meeting.track_name }}</h2>
                <span class="state-pill">{{ m.meeting.state }}</span>
                {% if ms.get('quaddie_hit', false) %}
                  <span class="jams-badge jams-badge--quaddie">QUADDIE</span>
                {% endif %}
                {% if ms.get('quinellas', 0) > 0 %}
                  <span class="jams-badge jams-badge--quin">{{ ms.get('quinellas', 0) }} QUIN</span>
                {% endif %}
                {% if ms.get('trifectas', 0) > 0 %}
                  <span class="jams-badge jams-badge--tri">{{ ms.get('trifectas', 0) }} TRI</span>
                {% endif %}
              </div>
              <div class="meeting-meta">
                {{ ms.get('wins', 0) }} winners from {{ ms.get('tips', 0) }} tips
                {% if ms.get('quaddie_legs', 0) > 0 and not ms.get('quaddie_hit', false) %}
                  Â· Quaddie {{ ms.get('quaddie_legs', 0) }}/4
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="meeting-body">
          {% for r in m.races %}
            {% set exotics = r.get('exotics_order', []) %}
            {% set has_tri = r.get('has_trifecta', false) %}
            {% set has_quin = r.get('has_quinella', false) %}
            {% set has_winner = r.tips | selectattr('placing', 'equalto', 1) | list | length > 0 %}

            {# Only show races with a winner or exotic #}
            {% if has_winner or has_tri or has_quin %}
            <div class="race-card {% if has_tri %}jams-race--trifecta{% elif has_quin %}jams-race--quinella{% endif %}">
              <div class="race-header">
                <div class="race-header-left">
                  <div class="race-title">Race {{ r.race_number }}{% if r.race_name %} â€“ {{ r.race_name }}{% endif %}</div>
                </div>
                <div class="race-header-right">
                  {% if has_tri %}
                    <span class="jams-badge jams-badge--tri">TRIFECTA</span>
                  {% elif has_quin %}
                    <span class="jams-badge jams-badge--quin">QUINELLA</span>
                  {% endif %}
                </div>
              </div>

              <table class="race-table jams-table">
                <thead>
                  <tr>
                    <th class="col-type">Type</th>
                    <th class="col-tab">TAB</th>
                    <th class="col-horse">Horse</th>
                    <th class="col-trainer">Trainer</th>
                    <th class="col-jockey">Jockey</th>
                    <th class="col-pos">Pos</th>
                    <th class="col-result">Result</th>
                  </tr>
                </thead>
                <tbody>
                  {% for t in r.tips %}
                    {% set is_winner = t.placing == 1 %}
                    {% set is_placed = t.placing is not none and t.placing <= 3 %}
                    <tr class="{% if is_winner %}jams-row--winner{% elif is_placed %}jams-row--placed{% endif %}">
                      <td class="col-type">
                        {% if t.tip_type == "AI_BEST" %}
                          <span class="pill pill-ai-best">AI BEST</span>
                        {% elif t.tip_type == "DANGER" %}
                          <span class="pill pill-danger">DANGER</span>
                        {% else %}
                          <span class="pill pill-danger">VALUE</span>
                        {% endif %}
                      </td>
                      <td class="col-tab">#{{ t.tab_number }}</td>
                      <td class="col-horse">{{ t.horse }}</td>
                      <td class="col-trainer jams-meta-cell">{{ t.trainer or 'â€“' }}</td>
                      <td class="col-jockey jams-meta-cell">{{ t.jockey or 'â€“' }}</td>
                      <td class="col-pos">
                        {% if t.placing %}
                          <span class="jams-placing jams-placing--{{ t.placing }}">
                            {{ t.placing }}{{ 'st' if t.placing == 1 else ('nd' if t.placing == 2 else ('rd' if t.placing == 3 else 'th')) }}
                          </span>
                        {% else %}
                          â€“
                        {% endif %}
                      </td>
                      <td class="col-result">
                        {% if is_winner %}
                          <span class="jams-result-badge jams-result-badge--win">WIN</span>
                        {% elif t.placing == 2 or t.placing == 3 %}
                          <span class="jams-result-badge jams-result-badge--place">PLACE</span>
                        {% else %}
                          â€“
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>

            </div>
            {% endif %}
          {% endfor %}
        </div>
      </section>
    {% endfor %}

  {% else %}
    <p class="empty-state">No data available for this date.</p>
  {% endif %}

</main>
{% endblock %}
