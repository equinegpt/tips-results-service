{% extends "base.html" %}

{% block title %}
  Jam's Data â€“ {{ date.strftime("%A %d %B %Y") }}
{% endblock %}

{% block body %}
<main class="page-root">

  {# Top header: logo + title + date picker #}
  <header class="page-header">
    <div class="page-header-left">
      <div class="brand-lockup">
        <img
          src="{{ url_for('static', path='stablfy-logo.png') }}"
          alt="Stablfy"
          class="brand-logo"
        />
        <div class="brand-text">
          <div class="brand-title">
            Jam's Data â€“ {{ date.strftime("%A %d %B %Y") }}
          </div>
          <div class="brand-subtitle">
            Tips Results Service
          </div>
        </div>
      </div>
    </div>

    <div class="page-header-right">
      <form class="date-form" method="get" action="/ui/jams-data">
        <span class="date-form-label">Date</span>
        <div class="date-form-input-wrap">
          <span class="date-form-icon">ðŸ“…</span>
          <input
            type="date"
            id="date"
            name="date"
            value="{{ date.isoformat() }}"
          />
        </div>
        <button type="submit" class="btn-go">Go</button>
      </form>
    </div>
  </header>

  {% if meetings|length > 0 %}

    {# Day summary card #}
    {% if day_summary is defined and day_summary %}
      {% set ds = day_summary %}
      <section class="meeting-card meeting-card--summary">
        <div class="meeting-header">
          <div class="meeting-header-left">
            <div class="meeting-title-block">
              <h2 class="meeting-title">Day Summary</h2>
              <div class="meeting-meta">{{ display_date }}</div>
            </div>
          </div>
        </div>
        <div class="meeting-body">
          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-label">Winners</div>
              <div class="summary-value">{{ ds.get('wins', 0) }} / {{ ds.get('tips', 0) }}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Strike Rate</div>
              <div class="summary-value">{{ "%.1f"|format(ds.get('strike_rate_pct', 0)) }}%</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Quinellas</div>
              <div class="summary-value jams-highlight-quin">{{ ds.get('quinellas', 0) }}</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Trifectas</div>
              <div class="summary-value jams-highlight-tri">{{ ds.get('trifectas', 0) }}</div>
            </div>
          </div>
        </div>
      </section>
    {% endif %}

    {# Per-meeting cards #}
    {% for m in meetings %}
      {% set ms = m.summary if m.summary is defined else {} %}
      <section class="meeting-card">
        <div class="meeting-header">
          <div class="meeting-header-left">
            <div class="meeting-title-block">
              <div class="meeting-title-row">
                <h2 class="meeting-title">{{ m.meeting.track_name }}</h2>
                <span class="state-pill">{{ m.meeting.state }}</span>
              </div>
              <div class="meeting-meta">
                {{ ms.get('wins', 0) }} winners from {{ ms.get('tips', 0) }} tips
                {% if ms.get('quinellas', 0) > 0 %} Â· <span class="jams-highlight-quin">{{ ms.get('quinellas', 0) }} Quinella{{ 's' if ms.get('quinellas', 0) > 1 else '' }}</span>{% endif %}
                {% if ms.get('trifectas', 0) > 0 %} Â· <span class="jams-highlight-tri">{{ ms.get('trifectas', 0) }} Trifecta{{ 's' if ms.get('trifectas', 0) > 1 else '' }}</span>{% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="meeting-body">
          {# Race table #}
          {% for r in m.races %}
            {% set exotics = r.get('exotics_order', []) %}
            {% set has_tri = r.get('has_trifecta', false) %}
            {% set has_quin = r.get('has_quinella', false) %}

            <div class="race-card {% if has_tri %}jams-race--trifecta{% elif has_quin %}jams-race--quinella{% endif %}">
              <div class="race-header">
                <div class="race-header-left">
                  <div class="race-title">Race {{ r.race_number }}</div>
                </div>
                <div class="race-header-right">
                  {% if has_tri %}
                    <span class="jams-badge jams-badge--tri">TRIFECTA</span>
                  {% elif has_quin %}
                    <span class="jams-badge jams-badge--quin">QUINELLA</span>
                  {% endif %}
                </div>
              </div>

              <table class="race-table">
                <thead>
                  <tr>
                    <th style="width: 100px;">Type</th>
                    <th style="width: 60px;">TAB</th>
                    <th>Horse</th>
                    <th style="width: 80px;">Finished</th>
                    <th style="width: 80px;">Result</th>
                  </tr>
                </thead>
                <tbody>
                  {% for t in r.tips %}
                    {% set is_winner = t.placing == 1 %}
                    {% set is_placed = t.placing is not none and t.placing <= 3 %}
                    <tr class="{% if is_winner %}jams-row--winner{% elif is_placed %}jams-row--placed{% endif %}">
                      <td>
                        {% if t.tip_type == "AI_BEST" %}
                          <span class="pill pill-ai-best">AI BEST</span>
                        {% elif t.tip_type == "DANGER" %}
                          <span class="pill pill-danger">DANGER</span>
                        {% elif t.tip_type == "VALUE" %}
                          <span class="pill pill-danger">VALUE</span>
                        {% endif %}
                      </td>
                      <td>#{{ t.tab_number }}</td>
                      <td>{{ t.horse }}</td>
                      <td>
                        {% if t.placing %}
                          <span class="jams-placing jams-placing--{{ t.placing }}">
                            {{ t.placing }}{{ 'st' if t.placing == 1 else ('nd' if t.placing == 2 else ('rd' if t.placing == 3 else 'th')) }}
                          </span>
                        {% else %}
                          <span style="color: var(--muted);">â€“</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if is_winner %}
                          <span class="jams-result-badge jams-result-badge--win">WIN</span>
                        {% elif t.placing == 2 or t.placing == 3 %}
                          <span class="jams-result-badge jams-result-badge--place">PLACE</span>
                        {% elif t.placing %}
                          <span style="color: var(--muted);">â€“</span>
                        {% else %}
                          <span style="color: var(--muted);">â€“</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>

              {# Exotic result summary #}
              {% if has_tri or has_quin %}
                <div class="jams-exotic-summary">
                  <strong>{{ 'Trifecta' if has_tri else 'Quinella' }} Order:</strong>
                  {% for ex in exotics %}
                    <span class="jams-exotic-item">
                      {{ ex.placing }}{{ 'st' if ex.placing == 1 else ('nd' if ex.placing == 2 else 'rd') }}
                      <span class="{% if ex.tip_type == 'AI_BEST' %}jams-type--ai{% elif ex.tip_type == 'DANGER' %}jams-type--danger{% else %}jams-type--value{% endif %}">{{ ex.tip_type }}</span>
                      (#{{ ex.tab_number }} {{ ex.horse }})
                    </span>
                    {% if not loop.last %} â†’ {% endif %}
                  {% endfor %}
                  {% if exotics|length > 0 and exotics[0].tip_type == 'AI_BEST' %}
                    <span class="jams-ai-first-badge">AI LED!</span>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </section>
    {% endfor %}

  {% else %}
    <p class="empty-state">No data available for this date.</p>
  {% endif %}

</main>
{% endblock %}
